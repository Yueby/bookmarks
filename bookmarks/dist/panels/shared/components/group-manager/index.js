"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const vue_1 = require("vue");
const utils_1 = require("../../utils");
const validation_1 = require("../../utils/validation");
/**
 * 分组管理器组件
 */
exports.default = (0, vue_1.defineComponent)({
    name: 'GroupManager',
    props: {
        groups: {
            type: Array,
            required: true
        },
        currentGroup: {
            type: Object,
            default: null
        }
    },
    emits: ['update:groups', 'update:currentGroup'],
    data() {
        return {
            showInput: false,
            newGroupName: '',
            dragState: '',
            dragIndex: -1
        };
    },
    computed: {
        sortedGroups() {
            return [...this.groups].sort((a, b) => a.order - b.order);
        }
    },
    methods: {
        /**
         * 添加分组
         */
        addGroup() {
            if (!this.newGroupName)
                return;
            if (!(0, validation_1.validateGroupName)(this.newGroupName)) {
                Editor.Dialog.warn('分组名称不能为空且长度不能超过20个字符');
                return;
            }
            const group = {
                id: (0, utils_1.generateId)(),
                name: this.newGroupName,
                bookmarkList: [],
                order: this.groups.length,
                createTime: Date.now(),
                updateTime: Date.now()
            };
            const newGroups = [...this.groups, group];
            this.$emit('update:groups', newGroups);
            this.newGroupName = '';
            this.showInput = false;
        },
        /**
         * 删除分组
         */
        removeGroup(group) {
            var _a;
            const newGroups = this.groups.filter(g => g.id !== group.id);
            this.$emit('update:groups', newGroups);
            if (((_a = this.currentGroup) === null || _a === void 0 ? void 0 : _a.id) === group.id) {
                this.$emit('update:currentGroup', null);
            }
        },
        /**
         * 切换分组
         */
        switchGroup(group) {
            this.$emit('update:currentGroup', group);
        },
        /**
         * 开始拖拽分组
         */
        dragStartGroup(event, group) {
            if (!event.dataTransfer)
                return;
            event.dataTransfer.setData('group-id', group.id);
            event.dataTransfer.effectAllowed = 'move';
            const target = event.target;
            target.classList.add('dragging');
            this.dragState = 'group';
            this.dragIndex = this.groups.findIndex(g => g.id === group.id);
        },
        /**
         * 拖拽结束
         */
        dragEndGroup(event) {
            const target = event.target;
            target.classList.remove('dragging');
            this.dragState = '';
            this.dragIndex = -1;
        },
        /**
         * 处理拖拽放置
         */
        async dropGroup(event, targetGroup) {
            event.preventDefault();
            if (!event.dataTransfer)
                return;
            try {
                const sourceId = event.dataTransfer.getData('group-id');
                if (!sourceId || sourceId === targetGroup.id)
                    return;
                const sourceIndex = this.groups.findIndex(g => g.id === sourceId);
                const targetIndex = this.groups.findIndex(g => g.id === targetGroup.id);
                if (sourceIndex > -1 && targetIndex > -1) {
                    const newGroups = [...this.groups];
                    const [movedGroup] = newGroups.splice(sourceIndex, 1);
                    newGroups.splice(targetIndex, 0, movedGroup);
                    // 更新排序
                    newGroups.forEach((group, index) => {
                        group.order = index;
                    });
                    this.$emit('update:groups', newGroups);
                }
            }
            catch (err) {
                (0, utils_1.handleError)(err, '移动分组失败');
            }
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zb3VyY2UvcGFuZWxzL3NoYXJlZC9jb21wb25lbnRzL2dyb3VwLW1hbmFnZXIvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw2QkFBc0M7QUFDdEMsdUNBQXNEO0FBQ3RELHVEQUEyRDtBQUczRDs7R0FFRztBQUNILGtCQUFlLElBQUEscUJBQWUsRUFBQztJQUMzQixJQUFJLEVBQUUsY0FBYztJQUNwQixLQUFLLEVBQUU7UUFDSCxNQUFNLEVBQUU7WUFDSixJQUFJLEVBQUUsS0FBeUM7WUFDL0MsUUFBUSxFQUFFLElBQUk7U0FDakI7UUFDRCxZQUFZLEVBQUU7WUFDVixJQUFJLEVBQUUsTUFBNkM7WUFDbkQsT0FBTyxFQUFFLElBQUk7U0FDaEI7S0FDSjtJQUNELEtBQUssRUFBRSxDQUFDLGVBQWUsRUFBRSxxQkFBcUIsQ0FBQztJQUMvQyxJQUFJO1FBQ0EsT0FBTztZQUNILFNBQVMsRUFBRSxLQUFLO1lBQ2hCLFlBQVksRUFBRSxFQUFFO1lBQ2hCLFNBQVMsRUFBRSxFQUFFO1lBQ2IsU0FBUyxFQUFFLENBQUMsQ0FBQztTQUNoQixDQUFDO0lBQ04sQ0FBQztJQUNELFFBQVEsRUFBRTtRQUNOLFlBQVk7WUFDUixPQUFPLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDOUQsQ0FBQztLQUNKO0lBQ0QsT0FBTyxFQUFFO1FBQ0w7O1dBRUc7UUFDSCxRQUFRO1lBQ0osSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZO2dCQUFFLE9BQU87WUFFL0IsSUFBSSxDQUFDLElBQUEsOEJBQWlCLEVBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxFQUFFO2dCQUN2QyxNQUFNLENBQUMs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clxuaW1wb3J0IHsgZ2VuZXJhdGVJZCwgaGFuZGxlRXJyb3IgfSBmcm9tICcuLi8uLi91dGlscyc7XHJcbmltcG9ydCB7IHZhbGlkYXRlR3JvdXBOYW1lIH0gZnJvbSAnLi4vLi4vdXRpbHMvdmFsaWRhdGlvbic7XHJcbmltcG9ydCB7IEFzc2V0R3JvdXAsIE5vZGVHcm91cCB9IGZyb20gJy4uLy4uL3R5cGVzJztcclxuXHJcbi8qKlxyXG4gKiDliIbnu4TnrqHnkIblmajnu4Tku7ZcclxuICovXHJcbmV4cG9ydCBkZWZhdWx0IGRlZmluZUNvbXBvbmVudCh7XHJcbiAgICBuYW1lOiAnR3JvdXBNYW5hZ2VyJyxcclxuICAgIHByb3BzOiB7XHJcbiAgICAgICAgZ3JvdXBzOiB7XHJcbiAgICAgICAgICAgIHR5cGU6IEFycmF5IGFzICgpID0+IChBc3NldEdyb3VwIHwgTm9kZUdyb3VwKVtdLFxyXG4gICAgICAgICAgICByZXF1aXJlZDogdHJ1ZVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgY3VycmVudEdyb3VwOiB7XHJcbiAgICAgICAgICAgIHR5cGU6IE9iamVjdCBhcyAoKSA9PiBBc3NldEdyb3VwIHwgTm9kZUdyb3VwIHwgbnVsbCxcclxuICAgICAgICAgICAgZGVmYXVsdDogbnVsbFxyXG4gICAgICAgIH1cclxuICAgIH0sXHJcbiAgICBlbWl0czogWyd1cGRhdGU6Z3JvdXBzJywgJ3VwZGF0ZTpjdXJyZW50R3JvdXAnXSxcclxuICAgIGRhdGEoKSB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgc2hvd0lucHV0OiBmYWxzZSxcclxuICAgICAgICAgICAgbmV3R3JvdXBOYW1lOiAnJyxcclxuICAgICAgICAgICAgZHJhZ1N0YXRlOiAnJyxcclxuICAgICAgICAgICAgZHJhZ0luZGV4OiAtMVxyXG4gICAgICAgIH07XHJcbiAgICB9LFxyXG4gICAgY29tcHV0ZWQ6IHtcclxuICAgICAgICBzb3J0ZWRHcm91cHMoKTogKEFzc2V0R3JvdXAgfCBOb2RlR3JvdXApW10ge1xyXG4gICAgICAgICAgICByZXR1cm4gWy4uLnRoaXMuZ3JvdXBzXS5zb3J0KChhLCBiKSA9PiBhLm9yZGVyIC0gYi5vcmRlcik7XHJcbiAgICAgICAgfVxyXG4gICAgfSxcclxuICAgIG1ldGhvZHM6IHtcclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDmt7vliqDliIbnu4RcclxuICAgICAgICAgKi9cclxuICAgICAgICBhZGRHcm91cCgpIHtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLm5ld0dyb3VwTmFtZSkgcmV0dXJuO1xyXG5cclxuICAgICAgICAgICAgaWYgKCF2YWxpZGF0ZUdyb3VwTmFtZSh0aGlzLm5ld0dyb3VwTmFtZSkpIHtcclxuICAgICAgICAgICAgICAgIEVkaXRvci5EaWFsb2cud2Fybign5YiG57uE5ZCN56ew5LiN6IO95Li656m65LiU6ZW/5bqm5LiN6IO96LaF6L+HMjDkuKrlrZfnrKYnKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3QgZ3JvdXAgPSB7XHJcbiAgICAgICAgICAgICAgICBpZDogZ2VuZXJhdGVJZCgpLFxyXG4gICAgICAgICAgICAgICAgbmFtZTogdGhpcy5uZXdHcm91cE5hbWUsXHJcbiAgICAgICAgICAgICAgICBib29rbWFya0xpc3Q6IFtdLFxyXG4gICAgICAgICAgICAgICAgb3JkZXI6IHRoaXMuZ3JvdXBzLmxlbmd0aCxcclxuICAgICAgICAgICAgICAgIGNyZWF0ZVRpbWU6IERhdGUubm93KCksXHJcbiAgICAgICAgICAgICAgICB1cGRhdGVUaW1lOiBEYXRlLm5vdygpXHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICBjb25zdCBuZXdHcm91cHMgPSBbLi4udGhpcy5ncm91cHMsIGdyb3VwXTtcclxuICAgICAgICAgICAgdGhpcy4kZW1pdCgndXBkYXRlOmdyb3VwcycsIG5ld0dyb3Vwcyk7XHJcbiAgICAgICAgICAgIHRoaXMubmV3R3JvdXBOYW1lID0gJyc7XHJcbiAgICAgICAgICAgIHRoaXMuc2hvd0lucHV0ID0gZmFsc2U7XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog5Yig6Zmk5YiG57uEXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgcmVtb3ZlR3JvdXAoZ3JvdXA6IEFzc2V0R3JvdXAgfCBOb2RlR3JvdXApIHtcclxuICAgICAgICAgICAgY29uc3QgbmV3R3JvdXBzID0gdGhpcy5ncm91cHMuZmlsdGVyKGcgPT4gZy5pZCAhPT0gZ3JvdXAuaWQpO1xyXG4gICAgICAgICAgICB0aGlzLiRlbWl0KCd1cGRhdGU6Z3JvdXBzJywgbmV3R3JvdXBzKTtcclxuICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEdyb3VwPy5pZCA9PT0gZ3JvdXAuaWQpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuJGVtaXQoJ3VwZGF0ZTpjdXJyZW50R3JvdXAnLCBudWxsKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOWIh+aNouWIhue7hFxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHN3aXRjaEdyb3VwKGdyb3VwOiBBc3NldEdyb3VwIHwgTm9kZUdyb3VwKSB7XHJcbiAgICAgICAgICAgIHRoaXMuJGVtaXQoJ3VwZGF0ZTpjdXJyZW50R3JvdXAnLCBncm91cCk7XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog5byA5aeL5ouW5ou95YiG57uEXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgZHJhZ1N0YXJ0R3JvdXAoZXZlbnQ6IERyYWdFdmVudCwgZ3JvdXA6IEFzc2V0R3JvdXAgfCBOb2RlR3JvdXApIHtcclxuICAgICAgICAgICAgaWYgKCFldmVudC5kYXRhVHJhbnNmZXIpIHJldHVybjtcclxuXHJcbiAgICAgICAgICAgIGV2ZW50LmRhdGFUcmFuc2Zlci5zZXREYXRhKCdncm91cC1pZCcsIGdyb3VwLmlkKTtcclxuICAgICAgICAgICAgZXZlbnQuZGF0YVRyYW5zZmVyLmVmZmVjdEFsbG93ZWQgPSAnbW92ZSc7XHJcblxyXG4gICAgICAgICAgICBjb25zdCB0YXJnZXQgPSBldmVudC50YXJnZXQgYXMgSFRNTEVsZW1lbnQ7XHJcbiAgICAgICAgICAgIHRhcmdldC5jbGFzc0xpc3QuYWRkKCdkcmFnZ2luZycpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5kcmFnU3RhdGUgPSAnZ3JvdXAnO1xyXG4gICAgICAgICAgICB0aGlzLmRyYWdJbmRleCA9IHRoaXMuZ3JvdXBzLmZpbmRJbmRleChnID0+IGcuaWQgPT09IGdyb3VwLmlkKTtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDmi5bmi73nu5PmnZ9cclxuICAgICAgICAgKi9cclxuICAgICAgICBkcmFnRW5kR3JvdXAoZXZlbnQ6IERyYWdFdmVudCkge1xyXG4gICAgICAgICAgICBjb25zdCB0YXJnZXQgPSBldmVudC50YXJnZXQgYXMgSFRNTEVsZW1lbnQ7XHJcbiAgICAgICAgICAgIHRhcmdldC5jbGFzc0xpc3QucmVtb3ZlKCdkcmFnZ2luZycpO1xyXG4gICAgICAgICAgICB0aGlzLmRyYWdTdGF0ZSA9ICcnO1xyXG4gICAgICAgICAgICB0aGlzLmRyYWdJbmRleCA9IC0xO1xyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOWkhOeQhuaLluaLveaUvue9rlxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIGFzeW5jIGRyb3BHcm91cChldmVudDogRHJhZ0V2ZW50LCB0YXJnZXRHcm91cDogQXNzZXRHcm91cCB8IE5vZGVHcm91cCkge1xyXG4gICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgICAgICBpZiAoIWV2ZW50LmRhdGFUcmFuc2ZlcikgcmV0dXJuO1xyXG5cclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHNvdXJjZUlkID0gZXZlbnQuZGF0YVRyYW5zZmVyLmdldERhdGEoJ2dyb3VwLWlkJyk7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXNvdXJjZUlkIHx8IHNvdXJjZUlkID09PSB0YXJnZXRHcm91cC5pZCkgcmV0dXJuO1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IHNvdXJjZUluZGV4ID0gdGhpcy5ncm91cHMuZmluZEluZGV4KGcgPT4gZy5pZCA9PT0gc291cmNlSWQpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0SW5kZXggPSB0aGlzLmdyb3Vwcy5maW5kSW5kZXgoZyA9PiBnLmlkID09PSB0YXJnZXRHcm91cC5pZCk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKHNvdXJjZUluZGV4ID4gLTEgJiYgdGFyZ2V0SW5kZXggPiAtMSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG5ld0dyb3VwcyA9IFsuLi50aGlzLmdyb3Vwc107XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgW21vdmVkR3JvdXBdID0gbmV3R3JvdXBzLnNwbGljZShzb3VyY2VJbmRleCwgMSk7XHJcbiAgICAgICAgICAgICAgICAgICAgbmV3R3JvdXBzLnNwbGljZSh0YXJnZXRJbmRleCwgMCwgbW92ZWRHcm91cCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8vIOabtOaWsOaOkuW6j1xyXG4gICAgICAgICAgICAgICAgICAgIG5ld0dyb3Vwcy5mb3JFYWNoKChncm91cCwgaW5kZXgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXAub3JkZXIgPSBpbmRleDtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZW1pdCgndXBkYXRlOmdyb3VwcycsIG5ld0dyb3Vwcyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgICAgICAgICAgaGFuZGxlRXJyb3IoZXJyLCAn56e75Yqo5YiG57uE5aSx6LSlJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbn0pOyAiXX0=